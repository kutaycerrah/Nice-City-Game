<!DOCTYPE html>
<html>
<head>
    <title>Grand Traffic Racer - Vice City Pursuit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Dancing+Script:wght@700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
        }
    }
    </script>

    <style>
        /* Genel Stil Ayarları */
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            -webkit-user-select: none;
            user-select: none;
        }
        /* Hata Mesajı Stili */
        #error-display {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(150, 0, 0, 0.9);
            color: white; z-index: 9999; padding: 20px;
            font-family: monospace; font-size: 16px;
            white-space: pre-wrap; overflow-y: scroll;
            box-sizing: border-box;
        }
        /* Arayüz Stilleri */
        #loading-screen, #name-entry-screen, #game-over-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            z-index: 100;
        }
        #loading-screen {
            background: linear-gradient(to bottom, #2c002e, #6a005f, #ff6a00, #ffb861);
            transition: opacity 1s ease-out;
        }
        #creator-credit {
            position: absolute; bottom: 20px; width: 100%;
            text-align: center; font-family: 'Dancing Script', cursive;
            font-size: 4vw; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        @media (min-width: 768px) { #creator-credit { font-size: 38px; } }
        #loading-logo { text-align: center; color: white; }
        .studio-name {
            font-family: 'Bebas Neue', sans-serif; font-size: 8vw;
            margin: 0 0 -20px 0; color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 20px #00d5ff, 0 0 30px #00d5ff;
        }
        #loading-logo h1 {
            font-family: 'Bebas Neue', sans-serif; font-size: 15vw;
            margin: 0; line-height: 0.8; letter-spacing: 2px;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.5); margin-top: 20px;
        }
        #loading-logo h2 {
            font-family: 'Dancing Script', cursive; font-size: 10vw;
            margin: 0; color: #ff89f3;
            text-shadow: 0 0 5px #ff89f3, 0 0 10px #ff89f3, 0 0 20px #ff00c1, 0 0 30px #ff00c1, 0 0 40px #ff00c1;
        }
        #loading-bar-container {
            width: 80%; max-width: 500px; height: 25px; background-color: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.5); border-radius: 15px;
            margin-top: 50px; padding: 3px; box-sizing: border-box;
        }
        #loading-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #d946ef 0%, #a200d6 100%);
            border-radius: 10px; transition: width 0.1s linear;
        }
        #loading-percentage {
            margin-top: 15px; font-family: 'Press Start 2P', cursive; color: white;
            font-size: 18px; text-shadow: 2px 2px 4px #000;
        }
        #name-entry-screen {
            background-color: rgba(0,0,0,0.85); color: white; 
            font-family: 'Press Start 2P', cursive; text-align: center;
            z-index: 99; opacity: 0; transition: opacity 1s ease-in-out; display: none;
        }
        #name-entry-screen.visible { display: flex; opacity: 1; }
        #name-entry-screen h2 { font-size: 8vw; text-shadow: 3px 3px 0px #c7006e; margin-bottom: 30px; }
        #name-entry-screen input, #name-entry-screen button { font-family: 'Press Start 2P', cursive; border-radius: 10px; }
        #name-entry-screen input {
            width: 80%; max-width: 400px; padding: 15px; font-size: 20px; text-align: center; 
            background-color: #333; border: 2px solid white; color: white;
        }
        #name-entry-screen button {
            margin-top: 30px; padding: 15px 25px; font-size: 20px; color: black;
            background-color: #e0e0e0; border: 2px solid #fff; cursor: pointer;
        }
        canvas, #ui-container, #mobile-controls, #mission-container { 
            display: none; opacity: 0; transition: opacity 1s ease-in-out;
        }
        canvas.visible, #ui-container.visible, #mobile-controls.visible, #mission-container.visible {
            display: block; opacity: 1;
        }
        #ui-container.visible, #mobile-controls.visible, #mission-container.visible { display: flex; }
        #ui-container {
            position: fixed; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box;
            justify-content: space-between; align-items: flex-start; pointer-events: none;
        }
        #left-ui { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; }
        #wanted-level { display: flex; gap: 8px; }
        .star { width: 30px; height: 30px; }
        #health-bar-container {
            width: 200px; height: 20px; background-color: rgba(0,0,0,0.5);
            border: 2px solid white; border-radius: 5px; padding: 2px;
        }
        #health-bar {
            width: 100%; height: 100%; background-color: #4CAF50; border-radius: 3px;
            transition: width 0.5s ease-out, background-color: 0.1s;
        }
        #health-bar.damaged { background-color: #f44336; }
        #score { color: #fff; font-size: 24px; text-shadow: 2px 2px 4px #000; font-family: 'Press Start 2P', cursive;}
        #game-over-screen {
            background-color: rgba(0,0,0,0.7); color: white; display: none;
            font-family: 'Press Start 2P', cursive; text-align: center;
        }
        #game-over-screen h1 { font-size: 10vw; text-shadow: 3px 3px 0px #c7006e; margin: 0; }
        #game-over-screen button {
            margin-top: 20px; padding: 15px 25px; font-size: 20px; color: black;
            background-color: #e0e0e0; border: 2px solid #fff; border-radius: 10px;
            cursor: pointer; pointer-events: auto; font-family: 'Press Start 2P', cursive;
        }
        #mobile-controls {
            position: fixed; bottom: 20px; width: 100%;
            justify-content: space-between; pointer-events: none; box-sizing: border-box;
        }
        #mobile-controls div { display: flex; padding: 0 20px; }
        #left-controls { flex-direction: column-reverse; align-items: center; }
        #right-controls { flex-direction: row; align-items: center; }
        .control-btn {
            width: 75px; height: 75px; background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5); color: white; font-size: 38px;
            font-weight: bold; border-radius: 50%; margin: 10px; display: flex;
            justify-content: center; align-items: center; -webkit-tap-highlight-color: transparent;
            pointer-events: auto; cursor: pointer; transition: background-color 0.1s ease;
        }
        #left-controls .control-btn { width: 80px; height: 80px; }
        .control-btn:active { background-color: rgba(255, 255, 255, 0.5); }
        @media (max-width: 768px) { #mobile-controls.visible { display: flex; } }
    </style>
</head>
<body>
    <!-- Yükleme Ekranı ve Menüler -->
    <div id="loading-screen">
        <div id="loading-logo">
            <h2 class="studio-name">KuAtAmA Games</h2>
            <h1>GRAND TRAFFIC<br>RACER</h1>
            <h2>Nice City</h2>
        </div>
        <div id="loading-bar-container"><div id="loading-bar"></div></div>
        <div id="loading-percentage">0%</div>
        <div id="creator-credit">Created By Atakan Cerrahoglu</div>
    </div>
    <div id="name-entry-screen">
        <h2>ISMINI GIR</h2>
        <input type="text" id="player-name-input" maxlength="12" placeholder="OYUNCU 1">
        <button id="start-game-button">OYUNA BASLA</button>
    </div>
    
    <!-- Oyun Alanı ve Arayüzü -->
    <canvas id="game"></canvas>
    <div id="ui-container">
        <div id="left-ui">
            <div id="wanted-level">
                <div id="star-1" class="star"></div><div id="star-2" class="star"></div><div id="star-3" class="star"></div><div id="star-4" class="star"></div><div id="star-5" class="star"></div>
            </div>
            <div id="health-bar-container"><div id="health-bar"></div></div>
        </div>
        <div id="score">SKOR: 0</div>
    </div>

    <!-- Oyun Sonu Ekranı ve Mobil Kontroller -->
    <div id="game-over-screen">
        <h1 id="game-over-text"></h1>
        <button onclick="location.reload()">Yeniden Basla</button>
    </div>
    <div id="mobile-controls">
        <div id="left-controls"><button id="brake-btn" class="control-btn">&darr;</button><button id="accel-btn" class="control-btn">&uarr;</button></div>
        <div id="right-controls"><button id="left-btn" class="control-btn">&larr;</button><button id="right-btn" class="control-btn">&rarr;</button></div>
    </div>

    <!-- Oyun Mantığı (JavaScript) -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- GLOBAL DEĞİŞKENLER ---
        let scene, camera, renderer, clock;
        let player, policeCar = null, road;
        let sounds;
        let roadLines = [], buildings = [], palmTrees = [], trafficCars = [], streetLights = [], statues = [], debrisParticles = [];
        let hemiLight, dirLight;
        let speed = 0, score = 0, wantedLevel = 0, playerHealth = 100;
        let isGameOver = false, canBeCaught = false, isRadioPlaying = false;
        let isAccelerating = false, isBraking = false, isTurningLeft = false, isTurningRight = false;
        let lastPoliceShotTime = 0, wantedLevelCooldown = 0, lastPoliceHitTime = 0, isCrashSoundPlaying = false;
        let sidewalkLeft, sidewalkRight, buildingGround, ocean, beach;
        const ROAD_WIDTH = 20, SIDEWALK_WIDTH = 5, SEGMENT_LENGTH = 1000, SEGMENT_COUNT = 3, TOTAL_LENGTH = 3 * SEGMENT_LENGTH;
        
        const STAR_EMPTY_SVG = `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>`;
        const STAR_FILLED_SVG = `<svg viewBox="0 0 24 24" fill="#FFC700" stroke="#FDB813" stroke-width="1"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>`;
        
        // --- Oyun Başlatma ve Kurulum Fonksiyonları ---

        window.addEventListener('DOMContentLoaded', () => { 
            loadSounds();
            loadAssets(); 
            setupGameStart(); 
        });

        function loadSounds() {
            sounds = {
                engine: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/engine_sound.ogg'], loop: true, volume: 0.1, html5: true }),
                crash: new Howl({ src: ['https://actions.google.com/sounds/v1/impacts/crash.ogg'], volume: 0.5 }),
                siren: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/police_sound.ogg'], loop: true, volume: 0.5 }),
                radio: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/Vice%20City%20Geceleri.mp3'], loop: true, volume: 0.6, html5: true })
            };
        }

        function loadAssets() {
            const loadingBar = document.getElementById('loading-bar');
            const loadingPercentage = document.getElementById('loading-percentage');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                if(progress > 100) progress = 100;
                loadingBar.style.width = progress + '%';
                loadingPercentage.innerText = Math.round(progress) + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        loadingScreen.style.opacity = '0';
                        
                        loadingScreen.addEventListener('transitionend', () => {
                            loadingScreen.style.display = 'none';
                        }, { once: true });

                        const nameEntryScreen = document.getElementById('name-entry-screen');
                        nameEntryScreen.style.display = 'flex'; 
                        setTimeout(() => nameEntryScreen.classList.add('visible'), 50);
                    }, 500);
                }
            }, 50);
        }

        function setupGameStart() {
            const startGameButton = document.getElementById('start-game-button');
            startGameButton.addEventListener('click', () => {
                if (!isRadioPlaying && sounds?.radio) {
                    sounds.radio.play(); isRadioPlaying = true;
                }
                const nameEntryScreen = document.getElementById('name-entry-screen');
                nameEntryScreen.classList.remove('visible');
                setTimeout(() => {
                    nameEntryScreen.style.display = 'none';
                    initializeGame();
                }, 1000);
            });
        }

        function initializeGame() { 
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a2a4a);
            scene.fog = new THREE.Fog(0x3a4a6a, 500, 2500);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000); 
            
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game'), antialias: true }); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
            renderer.shadowMap.enabled = true;
            
            hemiLight = new THREE.HemisphereLight(0xcceeff, 0x556688, 0.8);
            scene.add(hemiLight);
            dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(-50, 40, 20); 
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048; 
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight); 
            
            createWorld(); 
            updateHealth();
            setupControls(); 
            
            document.getElementById('game').classList.add('visible');
            document.getElementById('ui-container').classList.add('visible');
            if (window.innerWidth <= 768) {
                document.getElementById('mobile-controls').classList.add('visible');
            }

            animate(); 
            window.addEventListener('resize', onWindowResize, false);
            if (sounds?.engine) sounds.engine.play();
        }

        // --- Dünya ve Nesne Oluşturma Fonksiyonları ---

        function createWorld() { 
            createRoadAndSidewalks(); 
            createRoadLines(); 
            createScenery(); 
            createPlayer();
        }

        function createPlayer() {
            player = new THREE.Group();
            player.position.set(ROAD_WIDTH / 2 - 2, 0, 5); 
            scene.add(player);

            const loader = new GLTFLoader();
            loader.load(
                // HATA DÜZELTME: Tarayıcının dosyayı bulabilmesi için yolun başına ./ eklendi.
                './toyota_supra_3d_model_0818181456_texture.glb', 
                (gltf) => {
                    const model = gltf.scene;
                    model.scale.set(1.8, 1.8, 1.8);
                    model.rotation.y = Math.PI;
                    model.position.y = 0;
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    player.add(model);
                },
                undefined, 
                (error) => { console.error('3D model yüklenirken bir hata oluştu:', error); }
            );
            player.userData.isJumping = false;
            player.userData.verticalVelocity = 0;
        }

        function createPoliceCar() {
            if (policeCar) return;
            policeCar = new THREE.Group();
            
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x00008b, flatShading: true });
            const mainBody = new THREE.Mesh(new THREE.BoxGeometry(2.8, 1.2, 5.5), bodyMaterial);
            mainBody.position.y = 0.6; 
            mainBody.castShadow = true;
            policeCar.add(mainBody);
            
            policeCar.position.set(player.position.x, 0, player.position.z + 50);
            policeCar.rotation.y = Math.PI;
            scene.add(policeCar);
        }

        function createTrafficCar() { 
            const car = new THREE.Group();
            const material = new THREE.MeshPhongMaterial({ 
                color: new THREE.Color(0xffffff).setHex(Math.random() * 0xffffff), 
                flatShading: true 
            });
            const body = new THREE.Mesh(new THREE.BoxGeometry(2.5, 1.0, 5.0), material); 
            body.position.y = 0.5; 
            body.castShadow = true;
            car.add(body);
            
            const lanes = [-ROAD_WIDTH / 3, 0, ROAD_WIDTH / 3]; 
            car.position.x = lanes[Math.floor(Math.random() * lanes.length)];
            car.position.z = player.position.z - 300 - Math.random() * 400;
            
            car.userData.speed = 1.4 + Math.random() * 0.5;
            car.userData.isHit = false;
            car.userData.life = 0;
            car.userData.velocity = new THREE.Vector3();
            car.userData.spin = 0;
            trafficCars.push(car); 
            scene.add(car);
        }
        
        function createScenery() {
            const buildingMaterial = new THREE.MeshPhongMaterial({ color: 0x505050 });
            for (let i = 0; i < 50; i++) {
                const height = 20 + Math.random() * 60;
                const width = 15 + Math.random() * 10;
                const depth = 15 + Math.random() * 10;
                const building = new THREE.Mesh( new THREE.BoxGeometry(width, height, depth), buildingMaterial );
                building.castShadow = true;
                building.receiveShadow = true;
                building.position.set( (Math.random() > 0.5 ? 1 : -1) * (ROAD_WIDTH/2 + width/2 + Math.random()*20), height / 2, Math.random() * TOTAL_LENGTH - TOTAL_LENGTH / 2);
                buildings.push(building);
                scene.add(building);
            }
        }

        function createRoadAndSidewalks() {
            road = new THREE.Group();
            const roadMaterial = new THREE.MeshPhongMaterial({ color: 0x333333, shininess: 10 }); 
            const sidewalkMaterial = new THREE.MeshPhongMaterial({color:0x666666});
            
            for (let i = 0; i < SEGMENT_COUNT; i++) {
                const zPos = i * SEGMENT_LENGTH - TOTAL_LENGTH / 2;
                const segment = new THREE.Mesh(new THREE.PlaneGeometry(ROAD_WIDTH, SEGMENT_LENGTH), roadMaterial);
                segment.rotation.x = -Math.PI / 2;
                segment.position.y = 0.01;
                segment.position.z = zPos;
                segment.receiveShadow = true; 
                road.add(segment);

                const sidewalkL = new THREE.Mesh(new THREE.PlaneGeometry(SIDEWALK_WIDTH, SEGMENT_LENGTH), sidewalkMaterial);
                sidewalkL.rotation.x = -Math.PI/2; 
                sidewalkL.position.y = 0.1;
                sidewalkL.position.set(-ROAD_WIDTH/2 - SIDEWALK_WIDTH/2, 0.1, zPos);
                sidewalkL.receiveShadow = true;
                road.add(sidewalkL);

                const sidewalkR = sidewalkL.clone();
                sidewalkR.position.x = ROAD_WIDTH/2 + SIDEWALK_WIDTH/2;
                road.add(sidewalkR);
            }
            scene.add(road);
        }

        function createRoadLines() { 
            const lineMaterial = new THREE.MeshBasicMaterial({ color: 0xffd700 });
            const lineGeometry = new THREE.PlaneGeometry(0.4, 8);
            for (let i = 0; i < 100; i++) {
                 const line = new THREE.Mesh(lineGeometry, lineMaterial);
                 line.rotation.x = -Math.PI / 2;
                 line.position.y = 0.02;
                 line.position.z = i * 20 - TOTAL_LENGTH/2;
                 roadLines.push(line);
                 road.add(line);
            }
        }
        
        function createStreetLights() { /* ... */ }

        // --- Oyun Döngüsü ve Fizik Fonksiyonları ---

        function animate() { 
            requestAnimationFrame(animate); 
            if (isGameOver) return;

            const deltaTime = clock.getDelta();
            
            updatePlayerMovement(deltaTime);
            moveWorld(speed);
            updateTraffic(deltaTime);
            if (policeCar) updatePoliceAI(deltaTime);
            checkCollisions();
            updateCamera();

            score += speed;
            document.getElementById('score').innerText = `SKOR: ${Math.floor(score)}`;
            
            if (!policeCar && wantedLevel > 0) {
                 createPoliceCar();
                 canBeCaught = true;
            }
            
            renderer.render(scene, camera);
        }

        function updatePlayerMovement() {
            const topSpeed = 5.5;
            if (isAccelerating) { speed = Math.min(topSpeed, speed + 0.08); }
            else if (isBraking) { speed = Math.max(0, speed - 0.1); }
            else { speed *= 0.99; }

            const turnSpeed = speed > 0.5 ? 0.25 : 0;
            const limitLeft = -ROAD_WIDTH / 2 + 1.7;
            const limitRight = ROAD_WIDTH / 2 - 1.7;
            if (isTurningLeft) player.position.x = Math.max(limitLeft, player.position.x - turnSpeed);
            if (isTurningRight) player.position.x = Math.min(limitRight, player.position.x + turnSpeed);

            let targetTilt = 0;
            if (isTurningLeft) targetTilt = 0.1;
            else if (isTurningRight) targetTilt = -0.1;
            player.rotation.z = THREE.MathUtils.lerp(player.rotation.z, targetTilt, 0.08);
        }

        function updateCamera(){ 
            if (!player) return;
            const cameraTarget = new THREE.Vector3();
            cameraTarget.x = player.position.x; 
            cameraTarget.y = player.position.y + 8; 
            cameraTarget.z = player.position.z + 18;
            camera.position.lerp(cameraTarget, 0.08); 
            camera.lookAt(player.position.x, player.position.y + 1.0, player.position.z);
        }
        
        function moveWorld(currentSpeed) {
            const allObjects = [...buildings, ...trafficCars, ...road.children];
            allObjects.forEach(o => {
                o.position.z += currentSpeed;
                if (o.position.z > camera.position.z + SEGMENT_LENGTH) {
                    o.position.z -= TOTAL_LENGTH;
                }
            });
        }

        function updateTraffic(dT){
            if (trafficCars.length < 15 && Math.random() < 0.05) createTrafficCar();
            for (let i = trafficCars.length - 1; i >= 0; i--) {
                const car = trafficCars[i];
                if (car.userData.isHit) {
                    car.position.add(car.userData.velocity.clone().multiplyScalar(dT)); 
                    car.rotation.y += car.userData.spin * dT;
                    car.userData.life -= dT;
                    if(car.userData.life <= 0){ 
                        scene.remove(car); 
                        trafficCars.splice(i, 1); 
                    }
                } else {
                    // Normal trafik akışı için buraya kod eklenebilir
                }
            }
        }

        function checkCollisions() {
            if (!player || !player.children.length) return; 
            const playerBox = new THREE.Box3().setFromObject(player);

            for(let i = trafficCars.length - 1; i >= 0; i--){
                const car = trafficCars[i];
                if (car.userData.isHit) continue;
                const carBox = new THREE.Box3().setFromObject(car);
                if(playerBox.intersectsBox(carBox)){
                    if(!isCrashSoundPlaying){
                        isCrashSoundPlaying = true; 
                        if(sounds?.crash) sounds.crash.play();
                        setTimeout(() => { isCrashSoundPlaying = false; }, 200);
                    }

                    // Çarpışma fiziği
                    car.userData.isHit = true;
                    car.userData.life = 2.0;
                    const impactDir = new THREE.Vector3().subVectors(car.position, player.position).normalize();
                    car.userData.velocity.copy(impactDir).multiplyScalar(10 + speed).setY(2);
                    car.userData.spin = (Math.random() - 0.5) * 5;

                    speed *= 0.3; 
                    takeDamage(10);
                    if(wantedLevel < 5 && wantedLevelCooldown <= 0) { 
                        wantedLevel++; 
                        updateStarsUI();
                        wantedLevelCooldown = 5; 
                    }
                }
            }
        }
        
        function updatePoliceAI(dT) {
            if (!policeCar || !player) return;
            const targetPosition = new THREE.Vector3(player.position.x, policeCar.position.y, player.position.z + 20);
            policeCar.position.lerp(targetPosition, 0.03);
            
            if(wantedLevelCooldown > 0) wantedLevelCooldown -= dT;

            const dist = player.position.distanceTo(policeCar.position);
            if (dist < 8) {
                if (clock.getElapsedTime() - lastPoliceHitTime > 2.0) {
                     takeDamage(20, "YAKALANDIN");
                     lastPoliceHitTime = clock.getElapsedTime();
                }
            }
        }

        function setupControls(){
            const onKeyDown = e => {
                if(e.repeat) return;
                if (e.code === 'ArrowUp') isAccelerating = true;
                if (e.code === 'ArrowDown') isBraking = true;
                if (e.code === 'ArrowLeft') isTurningLeft = true;
                if (e.code === 'ArrowRight') isTurningRight = true;
            };
            const onKeyUp = e => {
                if (e.code === 'ArrowUp') isAccelerating = false;
                if (e.code === 'ArrowDown') isBraking = false;
                if (e.code === 'ArrowLeft') isTurningLeft = false;
                if (e.code === 'ArrowRight') isTurningRight = false;
            };
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            const addTouchListeners = (element, startCallback, endCallback) => {
                element.addEventListener('touchstart', (e) => { e.preventDefault(); startCallback(); }, { passive: false });
                element.addEventListener('touchend', endCallback);
                element.addEventListener('mousedown', startCallback);
                element.addEventListener('mouseup', endCallback);
            };

            addTouchListeners(document.getElementById('accel-btn'), () => isAccelerating = true, () => isAccelerating = false);
            addTouchListeners(document.getElementById('brake-btn'), () => isBraking = true, () => isBraking = false);
            addTouchListeners(document.getElementById('left-btn'), () => isTurningLeft = true, () => isTurningLeft = false);
            addTouchListeners(document.getElementById('right-btn'), () => isTurningRight = true, () => isTurningRight = false);
        }

        function updateHealth() {
            playerHealth = Math.max(0, Math.min(100, playerHealth));
            const healthBar = document.getElementById('health-bar');
            if (healthBar) {
                healthBar.style.width = playerHealth + '%';
                healthBar.style.backgroundColor = playerHealth <= 20 ? '#f44336' : playerHealth <= 50 ? '#FFC107' : '#4CAF50';
            }
        }

        function takeDamage(amount, reason = "WASTED"){
            if (isGameOver) return;
            playerHealth -= amount; 
            updateHealth();
            if(playerHealth <= 0){ 
                endGame(reason); 
            }
        }

        function endGame(reason){
            isGameOver = true;
            if (sounds?.siren) sounds.siren.stop();
            if (sounds?.engine) sounds.engine.stop();
            if (sounds?.radio) sounds.radio.stop();
            const gameOverText = document.getElementById('game-over-text');
            gameOverText.innerText = reason;
            document.getElementById('game-over-screen').style.display = 'flex';
        }

        function updateStarsUI(){ 
            for(let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star-${i}`);
                if (star) star.innerHTML = (i <= wantedLevel) ? STAR_FILLED_SVG : STAR_EMPTY_SVG; 
            }
        }

        function onWindowResize() { 
            if (camera) {
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
            }
            if (renderer) {
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Grand Traffic Racer - Vice City Pursuit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Dancing+Script:wght@700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
        }
    }
    </script>

    <style>
        /* Genel Stil Ayarları */
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            -webkit-user-select: none;
            user-select: none;
        }
        /* Hata Mesajı Stili */
        #error-display {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(150, 0, 0, 0.9);
            color: white; z-index: 9999; padding: 20px;
            font-family: monospace; font-size: 16px;
            white-space: pre-wrap; overflow-y: scroll;
            box-sizing: border-box;
        }
        /* Arayüz Stilleri */
        #loading-screen, #name-entry-screen, #game-over-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            z-index: 100;
        }
        #loading-screen {
            background: linear-gradient(to bottom, #2c002e, #6a005f, #ff6a00, #ffb861);
            transition: opacity 1s ease-out;
        }
        #creator-credit {
            position: absolute; bottom: 20px; width: 100%;
            text-align: center; font-family: 'Dancing Script', cursive;
            font-size: 4vw; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        @media (min-width: 768px) { #creator-credit { font-size: 38px; } }
        #loading-logo { text-align: center; color: white; }
        .studio-name {
            font-family: 'Bebas Neue', sans-serif; font-size: 8vw;
            margin: 0 0 -20px 0; color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 20px #00d5ff, 0 0 30px #00d5ff;
        }
        #loading-logo h1 {
            font-family: 'Bebas Neue', sans-serif; font-size: 15vw;
            margin: 0; line-height: 0.8; letter-spacing: 2px;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.5); margin-top: 20px;
        }
        #loading-logo h2 {
            font-family: 'Dancing Script', cursive; font-size: 10vw;
            margin: 0; color: #ff89f3;
            text-shadow: 0 0 5px #ff89f3, 0 0 10px #ff89f3, 0 0 20px #ff00c1, 0 0 30px #ff00c1, 0 0 40px #ff00c1;
        }
        #loading-bar-container {
            width: 80%; max-width: 500px; height: 25px; background-color: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.5); border-radius: 15px;
            margin-top: 50px; padding: 3px; box-sizing: border-box;
        }
        #loading-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #d946ef 0%, #a200d6 100%);
            border-radius: 10px; transition: width 0.1s linear;
        }
        #loading-percentage {
            margin-top: 15px; font-family: 'Press Start 2P', cursive; color: white;
            font-size: 18px; text-shadow: 2px 2px 4px #000;
        }
        #name-entry-screen {
            background-color: rgba(0,0,0,0.85); color: white; 
            font-family: 'Press Start 2P', cursive; text-align: center;
            z-index: 99; opacity: 0; transition: opacity 1s ease-in-out; display: none;
        }
        #name-entry-screen.visible { display: flex; opacity: 1; }
        #name-entry-screen h2 { font-size: 8vw; text-shadow: 3px 3px 0px #c7006e; margin-bottom: 30px; }
        #name-entry-screen input, #name-entry-screen button { font-family: 'Press Start 2P', cursive; border-radius: 10px; }
        #name-entry-screen input {
            width: 80%; max-width: 400px; padding: 15px; font-size: 20px; text-align: center; 
            background-color: #333; border: 2px solid white; color: white;
        }
        #name-entry-screen button {
            margin-top: 30px; padding: 15px 25px; font-size: 20px; color: black;
            background-color: #e0e0e0; border: 2px solid #fff; cursor: pointer;
        }
        canvas, #ui-container, #mobile-controls, #mission-container { 
            display: none; opacity: 0; transition: opacity 1s ease-in-out;
        }
        canvas.visible, #ui-container.visible, #mobile-controls.visible, #mission-container.visible {
            display: block; opacity: 1;
        }
        #ui-container.visible, #mobile-controls.visible, #mission-container.visible { display: flex; }
        #ui-container {
            position: fixed; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box;
            justify-content: space-between; align-items: flex-start; pointer-events: none;
        }
        #left-ui { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; }
        #wanted-level { display: flex; gap: 8px; }
        .star { width: 30px; height: 30px; }
        #health-bar-container {
            width: 200px; height: 20px; background-color: rgba(0,0,0,0.5);
            border: 2px solid white; border-radius: 5px; padding: 2px;
        }
        #health-bar {
            width: 100%; height: 100%; background-color: #4CAF50; border-radius: 3px;
            transition: width 0.5s ease-out, background-color: 0.1s;
        }
        #health-bar.damaged { background-color: #f44336; }
        #score { color: #fff; font-size: 24px; text-shadow: 2px 2px 4px #000; font-family: 'Press Start 2P', cursive;}
        #game-over-screen {
            background-color: rgba(0,0,0,0.7); color: white; display: none;
            font-family: 'Press Start 2P', cursive; text-align: center;
        }
        #game-over-screen h1 { font-size: 10vw; text-shadow: 3px 3px 0px #c7006e; margin: 0; }
        #game-over-screen button {
            margin-top: 20px; padding: 15px 25px; font-size: 20px; color: black;
            background-color: #e0e0e0; border: 2px solid #fff; border-radius: 10px;
            cursor: pointer; pointer-events: auto; font-family: 'Press Start 2P', cursive;
        }
        #mobile-controls {
            position: fixed; bottom: 20px; width: 100%;
            justify-content: space-between; pointer-events: none; box-sizing: border-box;
        }
        #mobile-controls div { display: flex; padding: 0 20px; }
        #left-controls { flex-direction: column-reverse; align-items: center; }
        #right-controls { flex-direction: row; align-items: center; }
        .control-btn {
            width: 75px; height: 75px; background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5); color: white; font-size: 38px;
            font-weight: bold; border-radius: 50%; margin: 10px; display: flex;
            justify-content: center; align-items: center; -webkit-tap-highlight-color: transparent;
            pointer-events: auto; cursor: pointer; transition: background-color 0.1s ease;
        }
        #left-controls .control-btn { width: 80px; height: 80px; }
        .control-btn:active { background-color: rgba(255, 255, 255, 0.5); }
        @media (max-width: 768px) { #mobile-controls.visible { display: flex; } }
    </style>
</head>
<body>
    <!-- Yükleme Ekranı ve Menüler -->
    <div id="loading-screen">
        <div id="loading-logo">
            <h2 class="studio-name">KuAtAmA Games</h2>
            <h1>GRAND TRAFFIC<br>RACER</h1>
            <h2>Nice City</h2>
        </div>
        <div id="loading-bar-container"><div id="loading-bar"></div></div>
        <div id="loading-percentage">0%</div>
        <div id="creator-credit">Created By Atakan Cerrahoglu</div>
    </div>
    <div id="name-entry-screen">
        <h2>ISMINI GIR</h2>
        <input type="text" id="player-name-input" maxlength="12" placeholder="OYUNCU 1">
        <button id="start-game-button">OYUNA BASLA</button>
    </div>
    
    <!-- Oyun Alanı ve Arayüzü -->
    <canvas id="game"></canvas>
    <div id="ui-container">
        <div id="left-ui">
            <div id="wanted-level">
                <div id="star-1" class="star"></div><div id="star-2" class="star"></div><div id="star-3" class="star"></div><div id="star-4" class="star"></div><div id="star-5" class="star"></div>
            </div>
            <div id="health-bar-container"><div id="health-bar"></div></div>
        </div>
        <div id="score">SKOR: 0</div>
    </div>

    <!-- Oyun Sonu Ekranı ve Mobil Kontroller -->
    <div id="game-over-screen">
        <h1 id="game-over-text"></h1>
        <button onclick="location.reload()">Yeniden Basla</button>
    </div>
    <div id="mobile-controls">
        <div id="left-controls"><button id="brake-btn" class="control-btn">&darr;</button><button id="accel-btn" class="control-btn">&uarr;</button></div>
        <div id="right-controls"><button id="left-btn" class="control-btn">&larr;</button><button id="right-btn" class="control-btn">&rarr;</button></div>
    </div>

    <!-- Oyun Mantığı (JavaScript) -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- GLOBAL DEĞİŞKENLER ---
        let scene, camera, renderer, clock;
        let player, policeCar = null, road;
        let sounds;
        let roadLines = [], buildings = [], palmTrees = [], trafficCars = [], streetLights = [], statues = [], debrisParticles = [];
        let hemiLight, dirLight;
        let speed = 0, score = 0, wantedLevel = 0, playerHealth = 100;
        let isGameOver = false, canBeCaught = false, isRadioPlaying = false;
        let isAccelerating = false, isBraking = false, isTurningLeft = false, isTurningRight = false;
        let lastPoliceShotTime = 0, wantedLevelCooldown = 0, lastPoliceHitTime = 0, isCrashSoundPlaying = false;
        let sidewalkLeft, sidewalkRight, buildingGround, ocean, beach;
        const ROAD_WIDTH = 20, SIDEWALK_WIDTH = 5, SEGMENT_LENGTH = 1000, SEGMENT_COUNT = 3, TOTAL_LENGTH = 3 * SEGMENT_LENGTH;
        
        const STAR_EMPTY_SVG = `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>`;
        const STAR_FILLED_SVG = `<svg viewBox="0 0 24 24" fill="#FFC700" stroke="#FDB813" stroke-width="1"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>`;
        
        // --- Oyun Başlatma ve Kurulum Fonksiyonları ---

        window.addEventListener('DOMContentLoaded', () => { 
            loadSounds();
            loadAssets(); 
            setupGameStart(); 
        });

        function loadSounds() {
            sounds = {
                engine: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/engine_sound.ogg'], loop: true, volume: 0.1, html5: true }),
                crash: new Howl({ src: ['https://actions.google.com/sounds/v1/impacts/crash.ogg'], volume: 0.5 }),
                siren: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/police_sound.ogg'], loop: true, volume: 0.5 }),
                radio: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/Vice%20City%20Geceleri.mp3'], loop: true, volume: 0.6, html5: true })
            };
        }

        function loadAssets() {
            const loadingBar = document.getElementById('loading-bar');
            const loadingPercentage = document.getElementById('loading-percentage');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                if(progress > 100) progress = 100;
                loadingBar.style.width = progress + '%';
                loadingPercentage.innerText = Math.round(progress) + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        loadingScreen.style.opacity = '0';
                        
                        loadingScreen.addEventListener('transitionend', () => {
                            loadingScreen.style.display = 'none';
                        }, { once: true });

                        const nameEntryScreen = document.getElementById('name-entry-screen');
                        nameEntryScreen.style.display = 'flex'; 
                        setTimeout(() => nameEntryScreen.classList.add('visible'), 50);
                    }, 500);
                }
            }, 50);
        }

        function setupGameStart() {
            const startGameButton = document.getElementById('start-game-button');
            startGameButton.addEventListener('click', () => {
                if (!isRadioPlaying && sounds?.radio) {
                    sounds.radio.play(); isRadioPlaying = true;
                }
                const nameEntryScreen = document.getElementById('name-entry-screen');
                nameEntryScreen.classList.remove('visible');
                setTimeout(() => {
                    nameEntryScreen.style.display = 'none';
                    initializeGame();
                }, 1000);
            });
        }

        function initializeGame() { 
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a2a4a);
            scene.fog = new THREE.Fog(0x3a4a6a, 500, 2500);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000); 
            
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game'), antialias: true }); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
            renderer.shadowMap.enabled = true;
            
            hemiLight = new THREE.HemisphereLight(0xcceeff, 0x556688, 0.8);
            scene.add(hemiLight);
            dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(-50, 40, 20); 
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048; 
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight); 
            
            createWorld(); 
            updateHealth();
            setupControls(); 
            
            document.getElementById('game').classList.add('visible');
            document.getElementById('ui-container').classList.add('visible');
            if (window.innerWidth <= 768) {
                document.getElementById('mobile-controls').classList.add('visible');
            }

            animate(); 
            window.addEventListener('resize', onWindowResize, false);
            if (sounds?.engine) sounds.engine.play();
        }

        // --- Dünya ve Nesne Oluşturma Fonksiyonları ---

        function createWorld() { 
            createRoadAndSidewalks(); 
            createRoadLines(); 
            createScenery(); 
            createPlayer();
        }

        function createPlayer() {
            player = new THREE.Group();
            player.position.set(ROAD_WIDTH / 2 - 2, 0, 5); 
            scene.add(player);

            const loader = new GLTFLoader();
            loader.load(
                // HATA DÜZELTME: Tarayıcının dosyayı bulabilmesi için yolun başına ./ eklendi.
                './toyota_supra_3d_model_0818181456_texture.glb', 
                (gltf) => {
                    const model = gltf.scene;
                    model.scale.set(1.8, 1.8, 1.8);
                    model.rotation.y = Math.PI;
                    model.position.y = 0;
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    player.add(model);
                },
                undefined, 
                (error) => { console.error('3D model yüklenirken bir hata oluştu:', error); }
            );
            player.userData.isJumping = false;
            player.userData.verticalVelocity = 0;
        }

        function createPoliceCar() {
            if (policeCar) return;
            policeCar = new THREE.Group();
            
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x00008b, flatShading: true });
            const mainBody = new THREE.Mesh(new THREE.BoxGeometry(2.8, 1.2, 5.5), bodyMaterial);
            mainBody.position.y = 0.6; 
            mainBody.castShadow = true;
            policeCar.add(mainBody);
            
            policeCar.position.set(player.position.x, 0, player.position.z + 50);
            policeCar.rotation.y = Math.PI;
            scene.add(policeCar);
        }

        function createTrafficCar() { 
            const car = new THREE.Group();
            const material = new THREE.MeshPhongMaterial({ 
                color: new THREE.Color(0xffffff).setHex(Math.random() * 0xffffff), 
                flatShading: true 
            });
            const body = new THREE.Mesh(new THREE.BoxGeometry(2.5, 1.0, 5.0), material); 
            body.position.y = 0.5; 
            body.castShadow = true;
            car.add(body);
            
            const lanes = [-ROAD_WIDTH / 3, 0, ROAD_WIDTH / 3]; 
            car.position.x = lanes[Math.floor(Math.random() * lanes.length)];
            car.position.z = player.position.z - 300 - Math.random() * 400;
            
            car.userData.speed = 1.4 + Math.random() * 0.5;
            car.userData.isHit = false;
            car.userData.life = 0;
            car.userData.velocity = new THREE.Vector3();
            car.userData.spin = 0;
            trafficCars.push(car); 
            scene.add(car);
        }
        
        function createScenery() {
            const buildingMaterial = new THREE.MeshPhongMaterial({ color: 0x505050 });
            for (let i = 0; i < 50; i++) {
                const height = 20 + Math.random() * 60;
                const width = 15 + Math.random() * 10;
                const depth = 15 + Math.random() * 10;
                const building = new THREE.Mesh( new THREE.BoxGeometry(width, height, depth), buildingMaterial );
                building.castShadow = true;
                building.receiveShadow = true;
                building.position.set( (Math.random() > 0.5 ? 1 : -1) * (ROAD_WIDTH/2 + width/2 + Math.random()*20), height / 2, Math.random() * TOTAL_LENGTH - TOTAL_LENGTH / 2);
                buildings.push(building);
                scene.add(building);
            }
        }

        function createRoadAndSidewalks() {
            road = new THREE.Group();
            const roadMaterial = new THREE.MeshPhongMaterial({ color: 0x333333, shininess: 10 }); 
            const sidewalkMaterial = new THREE.MeshPhongMaterial({color:0x666666});
            
            for (let i = 0; i < SEGMENT_COUNT; i++) {
                const zPos = i * SEGMENT_LENGTH - TOTAL_LENGTH / 2;
                const segment = new THREE.Mesh(new THREE.PlaneGeometry(ROAD_WIDTH, SEGMENT_LENGTH), roadMaterial);
                segment.rotation.x = -Math.PI / 2;
                segment.position.y = 0.01;
                segment.position.z = zPos;
                segment.receiveShadow = true; 
                road.add(segment);

                const sidewalkL = new THREE.Mesh(new THREE.PlaneGeometry(SIDEWALK_WIDTH, SEGMENT_LENGTH), sidewalkMaterial);
                sidewalkL.rotation.x = -Math.PI/2; 
                sidewalkL.position.y = 0.1;
                sidewalkL.position.set(-ROAD_WIDTH/2 - SIDEWALK_WIDTH/2, 0.1, zPos);
                sidewalkL.receiveShadow = true;
                road.add(sidewalkL);

                const sidewalkR = sidewalkL.clone();
                sidewalkR.position.x = ROAD_WIDTH/2 + SIDEWALK_WIDTH/2;
                road.add(sidewalkR);
            }
            scene.add(road);
        }

        function createRoadLines() { 
            const lineMaterial = new THREE.MeshBasicMaterial({ color: 0xffd700 });
            const lineGeometry = new THREE.PlaneGeometry(0.4, 8);
            for (let i = 0; i < 100; i++) {
                 const line = new THREE.Mesh(lineGeometry, lineMaterial);
                 line.rotation.x = -Math.PI / 2;
                 line.position.y = 0.02;
                 line.position.z = i * 20 - TOTAL_LENGTH/2;
                 roadLines.push(line);
                 road.add(line);
            }
        }
        
        function createStreetLights() { /* ... */ }

        // --- Oyun Döngüsü ve Fizik Fonksiyonları ---

        function animate() { 
            requestAnimationFrame(animate); 
            if (isGameOver) return;

            const deltaTime = clock.getDelta();
            
            updatePlayerMovement(deltaTime);
            moveWorld(speed);
            updateTraffic(deltaTime);
            if (policeCar) updatePoliceAI(deltaTime);
            checkCollisions();
            updateCamera();

            score += speed;
            document.getElementById('score').innerText = `SKOR: ${Math.floor(score)}`;
            
            if (!policeCar && wantedLevel > 0) {
                 createPoliceCar();
                 canBeCaught = true;
            }
            
            renderer.render(scene, camera);
        }

        function updatePlayerMovement() {
            const topSpeed = 5.5;
            if (isAccelerating) { speed = Math.min(topSpeed, speed + 0.08); }
            else if (isBraking) { speed = Math.max(0, speed - 0.1); }
            else { speed *= 0.99; }

            const turnSpeed = speed > 0.5 ? 0.25 : 0;
            const limitLeft = -ROAD_WIDTH / 2 + 1.7;
            const limitRight = ROAD_WIDTH / 2 - 1.7;
            if (isTurningLeft) player.position.x = Math.max(limitLeft, player.position.x - turnSpeed);
            if (isTurningRight) player.position.x = Math.min(limitRight, player.position.x + turnSpeed);

            let targetTilt = 0;
            if (isTurningLeft) targetTilt = 0.1;
            else if (isTurningRight) targetTilt = -0.1;
            player.rotation.z = THREE.MathUtils.lerp(player.rotation.z, targetTilt, 0.08);
        }

        function updateCamera(){ 
            if (!player) return;
            const cameraTarget = new THREE.Vector3();
            cameraTarget.x = player.position.x; 
            cameraTarget.y = player.position.y + 8; 
            cameraTarget.z = player.position.z + 18;
            camera.position.lerp(cameraTarget, 0.08); 
            camera.lookAt(player.position.x, player.position.y + 1.0, player.position.z);
        }
        
        function moveWorld(currentSpeed) {
            const allObjects = [...buildings, ...trafficCars, ...road.children];
            allObjects.forEach(o => {
                o.position.z += currentSpeed;
                if (o.position.z > camera.position.z + SEGMENT_LENGTH) {
                    o.position.z -= TOTAL_LENGTH;
                }
            });
        }

        function updateTraffic(dT){
            if (trafficCars.length < 15 && Math.random() < 0.05) createTrafficCar();
            for (let i = trafficCars.length - 1; i >= 0; i--) {
                const car = trafficCars[i];
                if (car.userData.isHit) {
                    car.position.add(car.userData.velocity.clone().multiplyScalar(dT)); 
                    car.rotation.y += car.userData.spin * dT;
                    car.userData.life -= dT;
                    if(car.userData.life <= 0){ 
                        scene.remove(car); 
                        trafficCars.splice(i, 1); 
                    }
                } else {
                    // Normal trafik akışı için buraya kod eklenebilir
                }
            }
        }

        function checkCollisions() {
            if (!player || !player.children.length) return; 
            const playerBox = new THREE.Box3().setFromObject(player);

            for(let i = trafficCars.length - 1; i >= 0; i--){
                const car = trafficCars[i];
                if (car.userData.isHit) continue;
                const carBox = new THREE.Box3().setFromObject(car);
                if(playerBox.intersectsBox(carBox)){
                    if(!isCrashSoundPlaying){
                        isCrashSoundPlaying = true; 
                        if(sounds?.crash) sounds.crash.play();
                        setTimeout(() => { isCrashSoundPlaying = false; }, 200);
                    }

                    // Çarpışma fiziği
                    car.userData.isHit = true;
                    car.userData.life = 2.0;
                    const impactDir = new THREE.Vector3().subVectors(car.position, player.position).normalize();
                    car.userData.velocity.copy(impactDir).multiplyScalar(10 + speed).setY(2);
                    car.userData.spin = (Math.random() - 0.5) * 5;

                    speed *= 0.3; 
                    takeDamage(10);
                    if(wantedLevel < 5 && wantedLevelCooldown <= 0) { 
                        wantedLevel++; 
                        updateStarsUI();
                        wantedLevelCooldown = 5; 
                    }
                }
            }
        }
        
        function updatePoliceAI(dT) {
            if (!policeCar || !player) return;
            const targetPosition = new THREE.Vector3(player.position.x, policeCar.position.y, player.position.z + 20);
            policeCar.position.lerp(targetPosition, 0.03);
            
            if(wantedLevelCooldown > 0) wantedLevelCooldown -= dT;

            const dist = player.position.distanceTo(policeCar.position);
            if (dist < 8) {
                if (clock.getElapsedTime() - lastPoliceHitTime > 2.0) {
                     takeDamage(20, "YAKALANDIN");
                     lastPoliceHitTime = clock.getElapsedTime();
                }
            }
        }

        function setupControls(){
            const onKeyDown = e => {
                if(e.repeat) return;
                if (e.code === 'ArrowUp') isAccelerating = true;
                if (e.code === 'ArrowDown') isBraking = true;
                if (e.code === 'ArrowLeft') isTurningLeft = true;
                if (e.code === 'ArrowRight') isTurningRight = true;
            };
            const onKeyUp = e => {
                if (e.code === 'ArrowUp') isAccelerating = false;
                if (e.code === 'ArrowDown') isBraking = false;
                if (e.code === 'ArrowLeft') isTurningLeft = false;
                if (e.code === 'ArrowRight') isTurningRight = false;
            };
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            const addTouchListeners = (element, startCallback, endCallback) => {
                element.addEventListener('touchstart', (e) => { e.preventDefault(); startCallback(); }, { passive: false });
                element.addEventListener('touchend', endCallback);
                element.addEventListener('mousedown', startCallback);
                element.addEventListener('mouseup', endCallback);
            };

            addTouchListeners(document.getElementById('accel-btn'), () => isAccelerating = true, () => isAccelerating = false);
            addTouchListeners(document.getElementById('brake-btn'), () => isBraking = true, () => isBraking = false);
            addTouchListeners(document.getElementById('left-btn'), () => isTurningLeft = true, () => isTurningLeft = false);
            addTouchListeners(document.getElementById('right-btn'), () => isTurningRight = true, () => isTurningRight = false);
        }

        function updateHealth() {
            playerHealth = Math.max(0, Math.min(100, playerHealth));
            const healthBar = document.getElementById('health-bar');
            if (healthBar) {
                healthBar.style.width = playerHealth + '%';
                healthBar.style.backgroundColor = playerHealth <= 20 ? '#f44336' : playerHealth <= 50 ? '#FFC107' : '#4CAF50';
            }
        }

        function takeDamage(amount, reason = "WASTED"){
            if (isGameOver) return;
            playerHealth -= amount; 
            updateHealth();
            if(playerHealth <= 0){ 
                endGame(reason); 
            }
        }

        function endGame(reason){
            isGameOver = true;
            if (sounds?.siren) sounds.siren.stop();
            if (sounds?.engine) sounds.engine.stop();
            if (sounds?.radio) sounds.radio.stop();
            const gameOverText = document.getElementById('game-over-text');
            gameOverText.innerText = reason;
            document.getElementById('game-over-screen').style.display = 'flex';
        }

        function updateStarsUI(){ 
            for(let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star-${i}`);
                if (star) star.innerHTML = (i <= wantedLevel) ? STAR_FILLED_SVG : STAR_EMPTY_SVG; 
            }
        }

        function onWindowResize() { 
            if (camera) {
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
            }
            if (renderer) {
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

    </script>
</body>
</html>

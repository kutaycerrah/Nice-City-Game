<!DOCTYPE html>
<html>
<head>
    <title>Grand Traffic Racer - Vice City Pursuit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Dancing+Script:wght@700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            -webkit-user-select: none;
            user-select: none;
        }
        #error-display {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(150, 0, 0, 0.9);
            color: white; z-index: 9999; padding: 20px;
            font-family: monospace; font-size: 16px;
            white-space: pre-wrap; overflow-y: scroll;
            box-sizing: border-box;
        }
        #debug-info {
            position: fixed; top: 10px; left: 10px;
            background-color: rgba(0, 0, 0, 0.7); color: #00ff00;
            padding: 10px; font-family: 'Press Start 2P', cursive;
            font-size: 12px; z-index: 1000; border: 1px solid #00ff00;
            line-height: 1.5; pointer-events: none;
        }
        #speech-bubbles-container {
            position: fixed; top: 100px; right: 20px;
            width: 200px; z-index: 900; display: flex;
            flex-direction: column; gap: 15px; pointer-events: none;
        }
        .speech-bubble {
            padding: 10px; background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px; font-family: 'Bebas Neue', sans-serif;
            font-size: 18px; color: black; text-align: center;
            border-width: 3px; border-style: solid; position: relative;
            opacity: 0; transition: opacity 0.3s ease-in-out; display: none;
        }
        .speech-bubble.visible { opacity: 1; }
        .speech-bubble.player { border-color: #d9534f; }
        .speech-bubble.police { border-color: #5cb85c; }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: 0;
            width: 0; height: 0; border: 15px solid transparent;
            border-top-color: inherit; border-bottom: 0; margin-left: -15px;
        }
        .speech-bubble.player::after { left: 80%; top: 100%; }
        .speech-bubble.police::after { left: 20%; top: 100%; }
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #2c002e, #6a005f, #ff6a00, #ffb861);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; transition: opacity 1s ease-out;
        }
        #creator-credit {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-family: 'Dancing Script', cursive;
            font-size: 4vw;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        @media (min-width: 768px) {
            #creator-credit {
                font-size: 38px;
            }
        }
        #loading-logo { text-align: center; color: white; }
        .studio-name {
            font-family: 'Bebas Neue', sans-serif; font-size: 8vw;
            margin: 0 0 -20px 0; color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 20px #00d5ff, 0 0 30px #00d5ff;
        }
        #loading-logo h1 {
            font-family: 'Bebas Neue', sans-serif; font-size: 15vw;
            margin: 0; line-height: 0.8; letter-spacing: 2px;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.5); margin-top: 20px;
        }
        #loading-logo h2 {
            font-family: 'Dancing Script', cursive; font-size: 10vw;
            margin: 0; color: #ff89f3;
            text-shadow: 0 0 5px #ff89f3, 0 0 10px #ff89f3, 0 0 20px #ff00c1, 0 0 30px #ff00c1, 0 0 40px #ff00c1;
        }
        #loading-bar-container {
            width: 80%; max-width: 500px; height: 25px; background-color: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.5); border-radius: 15px;
            margin-top: 50px; padding: 3px; box-sizing: border-box;
        }
        #loading-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #d946ef 0%, #a200d6 100%);
            border-radius: 10px; transition: width 0.1s linear;
        }
        #loading-percentage {
            margin-top: 15px; font-family: 'Press Start 2P', cursive; color: white;
            font-size: 18px; text-shadow: 2px 2px 4px #000;
        }
        #name-entry-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); color: white; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Press Start 2P', cursive; text-align: center;
            z-index: 99; opacity: 0; transition: opacity 1s ease-in-out;
        }
        #name-entry-screen.visible { display: flex; opacity: 1; }
        #name-entry-screen h2 { font-size: 8vw; text-shadow: 3px 3px 0px #c7006e; margin-bottom: 30px; }
        #name-entry-screen input {
            font-family: 'Press Start 2P', cursive; width: 80%; max-width: 400px; padding: 15px;
            font-size: 20px; text-align: center; background-color: #333;
            border: 2px solid white; color: white; border-radius: 10px;
        }
        #name-entry-screen button {
            margin-top: 30px; padding: 15px 25px; font-size: 20px; color: black;
            background-color: #e0e0e0; border: 2px solid #fff; border-radius: 10px;
            cursor: pointer; font-family: 'Press Start 2P', cursive;
        }
        #game, #ui-container, #mobile-controls, #mission-container { 
            display: none; opacity: 0; transition: opacity 1s ease-in-out;
        }
        #game.visible, #ui-container.visible, #mobile-controls.visible, #mission-container.visible {
            display: block; opacity: 1;
        }
        #ui-container.visible, #mobile-controls.visible, #mission-container.visible { display: flex; }
        #ui-container {
            position: fixed; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box;
            justify-content: space-between; align-items: flex-start; pointer-events: none;
        }
        #left-ui { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; }
        #wanted-level { display: flex; gap: 8px; }
        .star { width: 30px; height: 30px; }
        #health-bar-container {
            width: 200px; height: 20px; background-color: rgba(0,0,0,0.5);
            border: 2px solid white; border-radius: 5px; padding: 2px;
        }
        #health-bar {
            width: 100%; height: 100%; background-color: #4CAF50; border-radius: 3px;
            transition: width 0.5s ease-out, background-color: 0.1s;
        }
        #health-bar.damaged { background-color: #f44336; }
        #score { color: #fff; font-size: 24px; text-shadow: 2px 2px 4px #000; font-family: 'Press Start 2P', cursive;}
        #game-over-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); color: white; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Press Start 2P', cursive; text-align: center;
        }
        #game-over-screen h1 { font-size: 10vw; text-shadow: 3px 3px 0px #c7006e; margin: 0; }
        #game-over-screen button {
            margin-top: 20px; padding: 15px 25px; font-size: 20px; color: black;
            background-color: #e0e0e0; border: 2px solid #fff; border-radius: 10px;
            cursor: pointer; pointer-events: auto; font-family: 'Press Start 2P', cursive;
        }
        #mobile-controls {
            position: fixed; bottom: 20px; width: 100%;
            justify-content: space-between; pointer-events: none; box-sizing: border-box;
        }
        #mobile-controls div { display: flex; padding: 0 20px; }
        #left-controls { flex-direction: column-reverse; align-items: center; }
        #right-controls { flex-direction: row; align-items: center; }
        .control-btn {
            width: 75px; height: 75px; background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5); color: white; font-size: 38px;
            font-weight: bold; border-radius: 50%; margin: 10px; display: flex;
            justify-content: center; align-items: center; -webkit-tap-highlight-color: transparent;
            pointer-events: auto; cursor: pointer; transition: background-color 0.1s ease;
        }
        #left-controls .control-btn { width: 80px; height: 80px; }
        .control-btn:active { background-color: rgba(255, 255, 255, 0.5); }
        @media (max-width: 768px) { #mobile-controls.visible { display: flex; } }
        #mission-container {
            position: fixed; top: 20px; right: 20px; width: 300px;
            background-color: rgba(0, 0, 0, 0.7); border: 2px solid #FF89F3;
            border-radius: 10px; padding: 15px; color: white;
            font-family: 'Press Start 2P', cursive; font-size: 14px;
            text-shadow: 1px 1px 2px #000; pointer-events: auto;
            flex-direction: column; gap: 10px;
            opacity: 0; transition: opacity 0.5s ease-out;
        }
        #mission-container.visible { opacity: 1; }
        #mission-text { min-height: 40px; display: flex; align-items: center; justify-content: center; text-align: center; }
        #generate-mission-btn {
            background-color: #00ffff; color: #2c002e; padding: 10px 15px;
            border: none; border-radius: 5px; font-family: 'Press Start 2P', cursive;
            font-size: 16px; cursor: pointer; box-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        #generate-mission-btn:hover { background-color: #54fcfd; box-shadow: 0 0 10px #54fcfd, 0 0 20px #54fcfd; }
        #generate-mission-btn:disabled { background-color: #555; box-shadow: none; cursor: not-allowed; }
        
        #radio-ticker-bar {
            position: fixed;
            bottom: 20px;
            left: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00ff7f;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            padding: 8px;
            border: 1px solid #00ff7f;
            border-radius: 5px;
            overflow: hidden;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #radio-ticker-bar.visible {
            opacity: 1;
        }
        #radio-ticker-text {
            display: inline-block;
            padding-left: 100%;
            animation: ticker-scroll 15s linear;
        }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-150%); }
        }
    </style>
</head>
<body>
    <div id="error-display" style="display: none;"></div>
    <div id="debug-info"></div>
    <div id="speech-bubbles-container">
        <div id="player-speech-bubble" class="speech-bubble player"></div>
        <div id="police-speech-bubble" class="speech-bubble police"></div>
    </div>

    <div id="loading-screen">
        <div id="loading-logo">
            <h2 class="studio-name">KuAtAmA Games</h2>
            <h1>GRAND TRAFFIC<br>RACER</h1>
            <h2>Nice City</h2>
        </div>
        <div id="loading-bar-container"><div id="loading-bar"></div></div>
        <div id="loading-percentage">0%</div>
        <div id="creator-credit">Created By Atakan Cerrahoğlu</div>
    </div>
    <div id="name-entry-screen">
        <h2>ISMINI GIR</h2>
        <input type="text" id="player-name-input" maxlength="12" placeholder="OYUNCU 1">
        <button id="start-game-button">OYUNA BASLA</button>
    </div>
    
    <canvas id="game"></canvas>
    <div id="ui-container">
        <div id="left-ui">
            <div id="wanted-level">
                <div id="star-1" class="star"></div><div id="star-2" class="star"></div><div id="star-3" class="star"></div><div id="star-4" class="star"></div><div id="star-5" class="star"></div>
            </div>
            <div id="health-bar-container"><div id="health-bar"></div></div>
        </div>
        <div id="score">SKOR: 0</div>
    </div>

    <div id="mission-container">
        <div id="mission-text">Yeni bir gorev almak icin dugmeye bas!</div>
        <button id="generate-mission-btn">✨ Yeni Gorev Al</button>
    </div>

    <div id="radio-ticker-bar">
        <div id="radio-ticker-text"></div>
    </div>

    <div id="game-over-screen">
        <h1 id="game-over-text"></h1>
        <button onclick="location.reload()">Yeniden Basla</button>
    </div>
    <div id="mobile-controls">
        <div id="left-controls"><button id="brake-btn" class="control-btn">&darr;</button><button id="accel-btn" class="control-btn">&uarr;</button></div>
        <div id="right-controls"><button id="left-btn" class="control-btn">&larr;</button><button id="right-btn" class="control-btn">&rarr;</button></div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js';

        // --- SABİTLER ---
        const SPEECH_BUBBLE_INTERVAL = 15;
        const ROAD_WIDTH = 20, SIDEWALK_WIDTH = 5, BUILDING_GROUND_WIDTH = 150, BEACH_WIDTH = 100, SEGMENT_LENGTH = 1000, SEGMENT_COUNT = 3, TOTAL_LENGTH = 3 * SEGMENT_LENGTH;
        const POLICE_BOOST_DISABLE_DURATION = 20;
        const POLICE_RAM_COOLDOWN = 10;
        const STAR_EMPTY_SVG = `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>`;
        const STAR_FILLED_SVG = `<svg viewBox="0 0 24 24" fill="#FFD700" stroke="#FDB813" stroke-width="1"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>`;
        
        const FALLBACK_MISSIONS = [
            "Polise yakalanmadan 2 dakika boyunca hayatta kal.", "Canın %50'nin altına düşmeden Şehir Merkezi'ne ulaş.", "Şehirdeki 3 heykeli yok et.",
            "Trafikteki 5 araca çarparak kaos yarat.", "Polis arabasını 3 başka araca çarptırarak büyük bir kaza yaptır.", "Okyanus Kenarı yolunda 30 saniye boyunca son sürat ilerle."
        ];
        const FALLBACK_CHATTER = [
            "Merkez, şüpheli Ocean Drive'da güneye doğru ilerliyor.", "Tüm birimlere: Kırmızı spor araba takibe alındı, destek bekleniyor.", "Şüpheli Downtown bölgesinde görüldü, aşırı hız yapıyor.",
            "Dikkat, şüpheli tehlikeli manevralar yapıyor. Dikkatli yaklaşın.", "Takip devam ediyor, şüpheli Starfish Adası'na yöneldi."
        ];

        const BUILDING_TYPES = [ { type: 'shop', minFloors: 1, maxFloors: 2 }, { type: 'apartment', minFloors: 3, maxFloors: 8 }, { type: 'hotel', minFloors: 9, maxFloors: 15 } ];
        const NEON_COLORS = [0xff00ff, 0x00ffff, 0x54fcfd, 0xf72119, 0x00ff7f, 0xff89f3];
        const WINDOW_LIGHT_COLORS = [0xffffee, 0xffd8b1, 0xcce4ff];
        const TRAFFIC_CAR_COLORS = [0xAAAAAA, 0xDDDDDD, 0x333333, 0x800000, 0x003300, 0xC0C0C0, 0xFF0000, 0x00FF00, 0x0000FF, 0xFFA500, 0x800080, 0x008080, 0xFF4500, 0xDA70D6, 0x4B0082, 0xADFF2F, 0x00FFFF];
        const dayCycleParameters = {
            NIGHT:     { background: new THREE.Color(0x1a2a4a), fog: new THREE.Color(0x3a4a6a), hemiSky: new THREE.Color(0xcceeff), hemiGround: new THREE.Color(0x556688), dirLight: new THREE.Color(0xffffff), dirIntensity: 0.6, fogNear: 500, fogFar: 2500 },
            MORNING:   { background: new THREE.Color(0xf7b267), fog: new THREE.Color(0xe5989b), hemiSky: new THREE.Color(0xf7b267), hemiGround: new THREE.Color(0xc06c84), dirLight: new THREE.Color(0xffaa00), dirIntensity: 0.8, fogNear: 450, fogFar: 2000 },
            PRE_NOON:  { background: new THREE.Color(0x87ceeb), fog: new THREE.Color(0xa0dae9), hemiSky: new THREE.Color(0xadd8e6), hemiGround: new THREE.Color(0xa9a9a9), dirLight: new THREE.Color(0xffffff), dirIntensity: 1.0, fogNear: 400, fogFar: 1600 },
            NOON:      { background: new THREE.Color(0x87ceeb), fog: new THREE.Color(0xa0dae9), hemiSky: new THREE.Color(0xffffff), hemiGround: new THREE.Color(0xcccccc), dirLight: new THREE.Color(0xffffff), dirIntensity: 1.5, fogNear: 350, fogFar: 1500 },
            AFTERNOON: { background: new THREE.Color(0xa0d8e9), fog: new THREE.Color(0xb0c7db), hemiSky: new THREE.Color(0xf5f5dc), hemiGround: new THREE.Color(0xb0c7db), dirLight: new THREE.Color(0xffdd88), dirIntensity: 1.1, fogNear: 400, fogFar: 1800 },
            EVENING:   { background: new THREE.Color(0xff4e50), fog: new THREE.Color(0xff8c42), hemiSky: new THREE.Color(0xff6f61), hemiGround: new THREE.Color(0x6b5b95), dirLight: new THREE.Color(0xff6600), dirIntensity: 0.9, fogNear: 480, fogFar: 2200 }
        };
        const dayCyclePhases = ['NIGHT', 'MORNING', 'PRE_NOON', 'NOON', 'AFTERNOON', 'EVENING'];
        const dayCycleTime = 120; const phaseDuration = dayCycleTime / dayCyclePhases.length; let currentCycleTime = 0;
        
        // --- SES SABİTLERİ ---
        const MENU_VOLUME = 0.6; const RADIO_VOL_MAX = 0.6; const RADIO_VOL_MIN = 0.3;
        const ENGINE_VOL_MAX = 0.4; const ENGINE_VOL_MIN = 0.1; const SIREN_VOLUME = 0.5;

        // --- GLOBAL DEĞİŞKENLER ---
        let scene, camera, renderer, clock;
        let player, policeCar = null, sirenLightRed, sirenLightBlue, road;
        let sounds;
        let buildings = [], palmTrees = [], guardRails = [], trafficCars = [], streetLights = [], statues = [], debrisParticles = [], rain, bulletSparks = [];
        let hemiLight, dirLight;
        let speed = 0, score = 0, wantedLevel = 0, playerHealth = 100;
        let isGameOver = false, canBeCaught = false, isRaining = false, isRadioPlaying = false;
        let isAccelerating = false, isBraking = false, isTurningLeft = false, isTurningRight = false;
        let lastPoliceShotTime = 0, wantedLevelCooldown = 0, lastPoliceHitTime = 0, isCrashSoundPlaying = false;
        let beach, ocean, sidewalkLeft, sidewalkRight, buildingGround;
        let pedestrians = [];
        const PEDESTRIAN_SKIN_COLORS = ['#f2d5b1', '#c68642', '#8d5524', '#f5cba7', '#a16e4b'];
        const PEDESTRIAN_SHIRT_COLORS = [0x69d2e7, 0xa7dbd8, 0xf38630, 0xfa6900, 0xff4e50, 0xf9d423, 0xf8b195, 0xc06c84, 0xffffff, 0x333333];
        const PEDESTRIAN_PANTS_COLORS = [0x004d80, 0x333333, 'beige', 0x654321, 0x444444];
        let flyingDebris = [];
        
        // --- SİNEMATİK DEĞİŞKENLERİ ---
        let isIntroPlaying = true;
        let cinematicCameraTarget;

        const BOOST_CHARGE_TIME = 20, BOOST_DURATION = 3.5, BOOST_SPEED_MULTIPLIER = 1.6;
        let cleanDrivingTime = 0, isBoostAvailable = false, isBoosting = false, boostTimeRemaining = 0, lastAccelTapTime = 0, policeDisableTimer = 0;
        let hasPlayerMoved = false, policeSpawnTimer = -1, areHazardLightsOn = false, gameTime = 0;
        let nextChatterTime = 20, nextMissionPromptTime = 30, nextSpeechBubbleTime = 0; 
        const CHATTER_INTERVAL = 25, MISSION_PROMPT_INTERVAL = 45;
        let missionHideTimeout = null, lastKeyUpTime = 0;
        const policePhrases = ["Dur! Saga cek!", "Kacabilecegini mi sandin?", "Bu is burada bitti!", "Teslim ol!", "Daha fazla zorluk cikarma!"];
        const playerPhrases = ["Haha, cok beklersin!", "Sikiysa yakala!", "Tozumu yut bakalim!", "Beni asla yakalayamazsiniz!", "Bu sehir benim!"];

        // --- DOKU DEĞİŞKENLERİ ---
        let buildingTexture, palmTrunkTexture, palmLeafTexture;

        async function callGemini(prompt) {
            const isMissionPrompt = prompt.includes("görev hedefi oluştur");
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (!response.ok) { throw new Error(`API call failed with status: ${response.status}`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    return result.candidates[0].content.parts[0].text.trim();
                } else { throw new Error("API yanıtında geçerli bir aday bulunamadı."); }
            } catch (error) {
                console.error("Gemini API çağrı hatası:", error.message);
                return isMissionPrompt
                    ? FALLBACK_MISSIONS[Math.floor(Math.random() * FALLBACK_MISSIONS.length)]
                    : FALLBACK_CHATTER[Math.floor(Math.random() * FALLBACK_CHATTER.length)];
            }
        }

        function displayError(e) {
            const errorDisplay = document.getElementById('error-display');
            if (errorDisplay) {
                errorDisplay.style.display = 'block';
                errorDisplay.innerHTML = `<h1>OYUN HATASI!</h1><p>Uzgunuz, oyunda beklenmedik bir hata olustu.</p><p><strong>Hata Adi:</strong> ${e.name}</p><p><strong>Mesaj:</strong> ${e.message}</p><hr><p><strong>Teknik Detay (Stack Trace):</strong></p><pre>${e.stack}</pre>`;
            }
        }

        function loadSounds() {
            sounds = {
                engine: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/engine_sound.ogg'], loop: true, volume: ENGINE_VOL_MIN, html5: true }),
                crash: new Howl({ src: ['https://actions.google.com/sounds/v1/impacts/crash.ogg'], volume: 0.5 }),
                siren: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/police_sound.ogg'], loop: true, volume: SIREN_VOLUME }),
                radio: new Howl({ src: ['https://github.com/atakancerrahoglu/Nice-city/raw/refs/heads/main/Vice%20City%20Geceleri.mp3'], loop: true, volume: MENU_VOLUME, html5: true }),
                heal_sound: new Howl({ src: ['https://actions.google.com/sounds/v1/fantasy/spell_heal.ogg'], volume: 0.7 })
            };
        }

        function loadAssets() {
            const loadingBar = document.getElementById('loading-bar');
            const loadingPercentage = document.getElementById('loading-percentage');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                if(progress > 100) progress = 100;
                loadingBar.style.width = progress + '%';
                loadingPercentage.innerText = Math.round(progress) + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        const nameEntryScreen = document.getElementById('name-entry-screen');
                        nameEntryScreen.style.display = 'flex';
                        setTimeout(() => nameEntryScreen.classList.add('visible'), 50);
                        nameEntryScreen.addEventListener('transitionend', () => {
                            document.getElementById('loading-screen').style.display = 'none';
                        }, { once: true });
                    }, 500);
                }
            }, 50);
        }

        function setupGameStart() {
            const startGameButton = document.getElementById('start-game-button');
            const nameEntryScreen = document.getElementById('name-entry-screen');
            const playerNameInput = document.getElementById('player-name-input');
            playerNameInput.addEventListener('focus', () => {
                if (!isRadioPlaying && sounds?.radio) {
                    sounds.radio.play(); isRadioPlaying = true;
                }
            }, { once: true });
            startGameButton.addEventListener('click', () => {
                if (isRadioPlaying && sounds?.radio) {
                    sounds.radio.fade(MENU_VOLUME, RADIO_VOL_MAX, 1000);
                }
                nameEntryScreen.classList.remove('visible');
                setTimeout(() => {
                    nameEntryScreen.style.display = 'none';
                    initializeGame();
                }, 1000);
            });
        }
        
        function onWindowResize() { 
            if (camera) {
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
            }
            if (renderer) {
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }
        
        function createWorld() { 
            createRoadAndSidewalks(); 
            createStreetLights(); 
            createPlayer();
            createRain();
            createScenery(); 
        }
        
        function createStyledWheel() {
            const wheelGeom = new THREE.CylinderGeometry(0.5, 0.5, 0.5, 12);
            const tireMaterial = new THREE.MeshToonMaterial({ color: 0x111111 });
            const rimMaterial = new THREE.MeshBasicMaterial({ color: 0xcccccc });
            const materials = [
                tireMaterial, // side
                rimMaterial,  // top
                rimMaterial   // bottom
            ];
            const wheel = new THREE.Mesh(wheelGeom, materials);
            wheel.rotation.z = Math.PI / 2;
            return wheel;
        }

        function createPlayer() {
            player = new THREE.Group();
            const bodyMaterial = new THREE.MeshToonMaterial({ color: 0xFF0000 }); // Canlı kırmızı
            const secondaryMaterial = new THREE.MeshToonMaterial({ color: 0x222222 });
            const windowMaterial = new THREE.MeshToonMaterial({ color: 0x87CEEB, transparent: true, opacity: 0.6 }); // Açık mavi cam
            const lightMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFF88 }); // Farlar için basic material
            const taillightMaterial = new THREE.MeshBasicMaterial({ color: 0xFF0000 });
            
            const mainBody = new THREE.Mesh(new THREE.BoxGeometry(3.0, 0.6, 6.0), bodyMaterial);
            mainBody.position.y = 0.6; mainBody.castShadow = true; player.add(mainBody);
            const frontHood = new THREE.Mesh(new THREE.BoxGeometry(2.8, 0.3, 2.0), bodyMaterial);
            frontHood.position.set(0, 0.7, -3.0); player.add(frontHood);
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(2.4, 0.5, 2.5), bodyMaterial);
            cabin.position.set(0, 1.0, 0.5); player.add(cabin);
            const windshield = new THREE.Mesh(new THREE.BoxGeometry(2.0, 0.3, 0.1), windowMaterial);
            windshield.position.set(0, 1.2, -0.7); player.add(windshield);
            const rearWindow = new THREE.Mesh(new THREE.BoxGeometry(2.0, 0.3, 0.1), windowMaterial);
            rearWindow.position.set(0, 1.2, 1.7); player.add(rearWindow);
            const rearDeck = new THREE.Mesh(new THREE.BoxGeometry(2.8, 0.3, 2.0), bodyMaterial);
            rearDeck.position.set(0, 0.7, 3.0); player.add(rearDeck);
            const spoiler = new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.1, 0.6), secondaryMaterial);
            spoiler.position.set(0, 1.0, 4.2); player.add(spoiler);
            const diffuser = new THREE.Mesh(new THREE.BoxGeometry(2.8, 0.3, 0.2), secondaryMaterial);
            diffuser.position.set(0, 0.2, 3.0); player.add(diffuser);

            const headlight1 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.1), lightMaterial);
            headlight1.position.set(-1.2, 0.6, -3.01); 
            const headlight2 = headlight1.clone(); 
            headlight2.position.x = 1.2; 
            player.add(headlight1, headlight2);

            const taillight1 = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.3, 0.1), taillightMaterial);
            taillight1.position.set(-0.6, 0.6, 4.01); 
            const taillight2 = taillight1.clone(); 
            taillight2.position.x = 0.6; 
            player.add(taillight1, taillight2);

            const wFL = createStyledWheel(); wFL.position.set(-1.6, 0.5, -2.0);
            const wFR = createStyledWheel(); wFR.position.set(1.6, 0.5, -2.0);
            const wBL = createStyledWheel(); wBL.position.set(-1.6, 0.5, 2.0);
            const wBR = createStyledWheel(); wBR.position.set(1.6, 0.5, 2.0);
            player.add(wFL, wFR, wBL, wBR);
            
            player.position.set(0, 0, 5); 
            player.rotation.y = -Math.PI / 16; 

            player.userData.lights = {headlight1, headlight2, taillight1, taillight2};
            player.userData.isJumping = false;
            player.userData.verticalVelocity = 0;
            scene.add(player);
        }

        function createPoliceCar() {
            if (policeCar) return;
            policeCar = new THREE.Group();
            const greenBodyMaterial = new THREE.MeshToonMaterial({ color: 0x004d26 });
            const whiteBodyMaterial = new THREE.MeshToonMaterial({ color: 0xeeeeee });
            const blackTrimMaterial = new THREE.MeshToonMaterial({ color: 0x111111 });
            const windowMaterial = new THREE.MeshToonMaterial({ color: 0x222222, transparent: true, opacity: 0.7 });
            const taillightMaterial = new THREE.MeshBasicMaterial({ color: 0xbb0000 });

            const mainBody = new THREE.Mesh(new THREE.BoxGeometry(2.6, 0.7, 5.4), greenBodyMaterial);
            mainBody.position.y = 0.7; policeCar.add(mainBody);
            const chamferGeo = new THREE.BoxGeometry(0.15, 0.15, 5.4);
            const leftChamfer = new THREE.Mesh(chamferGeo, greenBodyMaterial);
            leftChamfer.position.set(-1.23, 0.98, 0); leftChamfer.rotation.z = Math.PI / 4; policeCar.add(leftChamfer);
            const rightChamfer = leftChamfer.clone(); rightChamfer.position.x = 1.23; rightChamfer.rotation.z = -Math.PI / 4; policeCar.add(rightChamfer);
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(2.3, 0.6, 2.5), whiteBodyMaterial);
            cabin.position.set(0, 1.3, -0.3); policeCar.add(cabin);
            const windshield = new THREE.Mesh(new THREE.PlaneGeometry(2.1, 0.65), windowMaterial);
            windshield.position.set(0, 1.3, -1.55); windshield.rotation.x = -Math.PI / 8; policeCar.add(windshield);
            const rearWindow = new THREE.Mesh(new THREE.PlaneGeometry(2.1, 0.65), windowMaterial);
            rearWindow.position.set(0, 1.3, 0.95); rearWindow.rotation.x = Math.PI / 9; policeCar.add(rearWindow);
            const hood = new THREE.Mesh(new THREE.BoxGeometry(2.4, 0.5, 2.0), greenBodyMaterial);
            hood.position.set(0, 0.65, -2.2); policeCar.add(hood);
            const trunk = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.4, 1.5), greenBodyMaterial);
            trunk.position.set(0, 0.6, 2.0); policeCar.add(trunk);
            const leftWhitePanel = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.6, 2.6), whiteBodyMaterial);
            leftWhitePanel.position.set(-1.3, 0.7, -0.4); policeCar.add(leftWhitePanel);
            const rightWhitePanel = leftWhitePanel.clone(); rightWhitePanel.position.x = 1.3; policeCar.add(rightWhitePanel);
            
            const taillightGeo = new THREE.BoxGeometry(1.2, 0.35, 0.1);
            const leftTaillight = new THREE.Mesh(taillightGeo, taillightMaterial);
            leftTaillight.position.set(-0.65, 0.7, 2.75); policeCar.add(leftTaillight);
            const rightTaillight = new THREE.Mesh(taillightGeo, taillightMaterial);
            rightTaillight.position.set(0.65, 0.7, 2.75); policeCar.add(rightTaillight);
            
            const sirenBase = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.05, 0.5), blackTrimMaterial);
            sirenBase.position.set(0, 1.6, -0.3); policeCar.add(sirenBase);
            sirenLightRed = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.25, 0.5), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
            sirenLightRed.position.set(-0.3, 1.7, -0.3); policeCar.add(sirenLightRed);
            sirenLightBlue = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.25, 0.5), new THREE.MeshBasicMaterial({ color: 0x0000ff }));
            sirenLightBlue.position.set(0.3, 1.7, -0.3); policeCar.add(sirenLightBlue);
            
            const wFL = createStyledWheel(); wFL.position.set(-1.3, 0.4, -1.6); 
            const wFR = createStyledWheel(); wFR.position.set(1.3, 0.4, -1.6);
            const wBL = createStyledWheel(); wBL.position.set(-1.3, 0.4, 1.8); 
            const wBR = createStyledWheel(); wBR.position.set(1.3, 0.4, 1.8); 
            policeCar.add(wFL, wFR, wBL, wBR);

            const policeHeadlight1 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.1), new THREE.MeshBasicMaterial({ color: 0xFFFF88 }));
            policeHeadlight1.position.set(-1.0, 0.7, -2.51); 
            const policeHeadlight2 = policeHeadlight1.clone(); 
            policeHeadlight2.position.x = 1.0; 
            policeCar.add(policeHeadlight1, policeHeadlight2);

            policeCar.position.set(player.position.x, 0, player.position.z + 50); policeCar.rotation.y = Math.PI; policeCar.userData.health = 100;
            policeCar.userData.aiState = 'following';
            policeCar.userData.aiTimer = Math.random() * 3 + 4;
            policeCar.userData.lights = { headlight1: policeHeadlight1, headlight2: policeHeadlight2, taillight1: leftTaillight, taillight2: rightTaillight };
            scene.add(policeCar);
        }

        // --- Diğer create... fonksiyonları (pedestrian, debris, ambulance, traffic cars etc.) buraya gelecek ---
        // ... Bu fonksiyonlar önceki koddan alınabilir, materyalleri MeshToonMaterial olarak değiştirilebilir ...
        
        // Örnek olarak createBuilding fonksiyonunun güncellenmiş hali
        function createBuilding(x, z) {
            const bD = BUILDING_TYPES[Math.floor(Math.random() * BUILDING_TYPES.length)];
            const nF = bD.minFloors + Math.floor(Math.random() * (bD.maxFloors - bD.minFloors + 1));
            const bH = nF * 5; const bW = 15 + Math.random() * 5; const bDe = 15 + Math.random() * 5;
            const bG = new THREE.BoxGeometry(bW, bH, bDe);
            
            const buildingMaterial = new THREE.MeshToonMaterial({ 
                map: buildingTexture,
            });

            const bMe = new THREE.Mesh(bG, buildingMaterial); bMe.castShadow = true; bMe.receiveShadow = true;
            const bGr = new THREE.Group(); bGr.add(bMe);
            
            bGr.position.set(x, bH / 2, z); buildings.push(bGr); scene.add(bGr);
        }


        // --- Ana Fonksiyonlar (moveWorld, update..., check..., vb.) ---
        // ... Bu fonksiyonlar da önceki koddan alınarak, yeni yapıya (InstancedMesh vs) göre güncellenmeli ...

        function updatePlayerMovement() {
            if (isIntroPlaying) return;
            
            const topSpeed = 7.5; 
            const acceleration = 0.15;
            if (isBoosting) {
                const boostTargetSpeed = topSpeed * BOOST_SPEED_MULTIPLIER;
                speed = Math.min(boostTargetSpeed, speed + 0.25);
            } else {
                if(isAccelerating) { speed = Math.min(topSpeed, speed + acceleration); } 
                else if(isBraking) { speed = Math.max(0, speed - 0.1); } 
                else { speed *= 0.985; } // Daha yavaş yavaşlama
            }
            if (!hasPlayerMoved && speed > 0.1) {
                hasPlayerMoved = true;
                areHazardLightsOn = false;
                policeSpawnTimer = 10;
            }
            const turnSpeed = speed > 0.5 ? 0.35 : 0;
            const limitLeft = -ROAD_WIDTH / 2 - SIDEWALK_WIDTH - BEACH_WIDTH + 15;
            const limitRight = ROAD_WIDTH / 2 + SIDEWALK_WIDTH + BUILDING_GROUND_WIDTH - 15;
            if(isTurningLeft) player.position.x = Math.max(limitLeft, player.position.x - turnSpeed);
            if(isTurningRight) player.position.x = Math.min(limitRight, player.position.x + turnSpeed);
            
            let targetTilt = 0;
            if (isTurningLeft) targetTilt = 0.1;
            else if (isTurningRight) targetTilt = -0.1;
            player.rotation.z = THREE.MathUtils.lerp(player.rotation.z, targetTilt, 0.08);
            player.rotation.y = THREE.MathUtils.lerp(player.rotation.y, 0, 0.05);
        }

        function createRoadAndSidewalks() { 
            road = new THREE.Group();
            const roadMaterial = new THREE.MeshToonMaterial({ color: 0x999999 }); // Açık ton yol
            
            for (let i = 0; i < SEGMENT_COUNT; i++) {
                const segment = new THREE.Mesh(new THREE.PlaneGeometry(ROAD_WIDTH, SEGMENT_LENGTH), roadMaterial);
                segment.rotation.x = -Math.PI / 2; 
                segment.position.z = i * SEGMENT_LENGTH - TOTAL_LENGTH / 2;
                segment.receiveShadow = true; 
                road.add(segment);
            }
            scene.add(road);

            const lineMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const lineLength = 4;
            const lineGap = 6;
            const lineGeo = new THREE.PlaneGeometry(0.3, lineLength);
            
            [-ROAD_WIDTH / 6, ROAD_WIDTH / 6].forEach(lineX => {
                 for(let z = -TOTAL_LENGTH / 2; z < TOTAL_LENGTH / 2; z += lineLength + lineGap) {
                    const line = new THREE.Mesh(lineGeo, lineMaterial);
                    line.rotation.x = -Math.PI / 2;
                    line.position.set(lineX, 0.02, z);
                    road.add(line);
                }
            });
        }

        function createScenery(){ 
            sidewalkLeft = new THREE.Group(); 
            beach = new THREE.Group(); 
            ocean = new THREE.Group();
            sidewalkRight = new THREE.Group();
            buildingGround = new THREE.Group();
            
            const sidewalkMaterial = new THREE.MeshToonMaterial({ color: 0xBBBBBB });
            const beachMaterial = new THREE.MeshToonMaterial({ color: 0xFFE4B5 }); // Canlı kum rengi
            const oceanMaterial = new THREE.MeshToonMaterial({color: 0x00BFFF }); // Canlı okyanus rengi
            const groundMaterial = new THREE.MeshToonMaterial({ color: 0xA9A9A9 });

            for(let i = 0; i < SEGMENT_COUNT; i++){
                const zPosition = i * SEGMENT_LENGTH - TOTAL_LENGTH / 2;
                
                // Sol Taraf (Plaj)
                const sidewalkL = new THREE.Mesh(new THREE.PlaneGeometry(SIDEWALK_WIDTH, SEGMENT_LENGTH), sidewalkMaterial);
                sidewalkL.rotation.x = -Math.PI / 2; sidewalkL.position.set(-ROAD_WIDTH/2 - SIDEWALK_WIDTH/2, 0.1, zPosition); sidewalkL.receiveShadow = true; sidewalkLeft.add(sidewalkL);
                const beachSegment = new THREE.Mesh(new THREE.PlaneGeometry(BEACH_WIDTH, SEGMENT_LENGTH), beachMaterial);
                beachSegment.rotation.x = -Math.PI / 2; beachSegment.position.set(-ROAD_WIDTH/2 - SIDEWALK_WIDTH - BEACH_WIDTH/2, 0, zPosition); beach.add(beachSegment);
                const oceanSegment = new THREE.Mesh(new THREE.PlaneGeometry(400, SEGMENT_LENGTH, 20, 10), oceanMaterial);
                oceanSegment.rotation.x = -Math.PI / 2; oceanSegment.position.set(-ROAD_WIDTH/2 - SIDEWALK_WIDTH - BEACH_WIDTH - 200, -0.1, zPosition); ocean.add(oceanSegment);

                // Sağ Taraf (Binalar)
                const sidewalkR = new THREE.Mesh(new THREE.PlaneGeometry(SIDEWALK_WIDTH, SEGMENT_LENGTH), sidewalkMaterial);
                sidewalkR.rotation.x = -Math.PI / 2; sidewalkR.position.set(ROAD_WIDTH/2 + SIDEWALK_WIDTH/2, 0.1, zPosition); sidewalkR.receiveShadow = true; sidewalkRight.add(sidewalkR);
                const groundR = new THREE.Mesh(new THREE.PlaneGeometry(BUILDING_GROUND_WIDTH, SEGMENT_LENGTH), groundMaterial);
                groundR.rotation.x = -Math.PI / 2; groundR.position.set(ROAD_WIDTH/2 + SIDEWALK_WIDTH + BUILDING_GROUND_WIDTH/2, 0.1, zPosition); groundR.receiveShadow = true; buildingGround.add(groundR);
            } 
            scene.add(sidewalkLeft, beach, ocean, sidewalkRight, buildingGround);
            
            // Binaları sadece sağa yerleştir
            for (let i = 0; i < 40; i++) { 
                const xPos = ROAD_WIDTH / 2 + SIDEWALK_WIDTH + (Math.random() * (BUILDING_GROUND_WIDTH - 20));
                createBuilding(xPos, Math.random() * TOTAL_LENGTH - TOTAL_LENGTH / 2);
            }
        }
        
        let palmTrunkInstances, palmLeafInstances;
        function initializePalmTrees() {
            const PALM_COUNT = 150;
            const trunkGeo = new THREE.CylinderGeometry(0.2, 0.4, 14, 5); // Daha az detay
            const leafGeo = new THREE.PlaneGeometry(6, 6);
            
            const trunkMat = new THREE.MeshToonMaterial({ map: palmTrunkTexture, color: 0x654321 });
            const leafMat = new THREE.MeshToonMaterial({ map: palmLeafTexture, color: 0x2E8B57, side: THREE.DoubleSide, transparent: true, alphaTest: 0.5 });
            
            palmTrunkInstances = new THREE.InstancedMesh(trunkGeo, trunkMat, PALM_COUNT);
            palmLeafInstances = new THREE.InstancedMesh(leafGeo, leafMat, PALM_COUNT * 6); // Her ağaç için 6 yaprak
            
            palmTrunkInstances.castShadow = false;
            palmTrunkInstances.receiveShadow = true;
            palmLeafInstances.castShadow = false;
            palmLeafInstances.receiveShadow = false;

            scene.add(palmTrunkInstances);
            scene.add(palmLeafInstances);
            
            const dummy = new THREE.Object3D();
            let leafIndex = 0;
            for(let i=0; i < PALM_COUNT; i++) {
                const xPos = -ROAD_WIDTH/2 - SIDEWALK_WIDTH - (Math.random() * (BEACH_WIDTH - 10) );
                const zPos = Math.random() * TOTAL_LENGTH - TOTAL_LENGTH / 2;
                
                dummy.position.set(xPos, 7, zPos);
                dummy.updateMatrix();
                palmTrunkInstances.setMatrixAt(i, dummy.matrix);

                // Yaprakları oluştur ve konumlandır
                for (let j = 0; j < 6; j++) {
                    dummy.position.set(xPos, 14, zPos); // Gövdenin tepesi
                    dummy.rotation.y = (j / 6) * Math.PI * 2 + Math.random() * 0.5;
                    dummy.rotation.x = Math.PI / 4 + Math.random() * 0.2;
                    dummy.updateMatrix();
                    palmLeafInstances.setMatrixAt(leafIndex++, dummy.matrix);
                }
            }
            palmTrunkInstances.instanceMatrix.needsUpdate = true;
            palmLeafInstances.instanceMatrix.needsUpdate = true;
        }


        function initializeGame() { 
            try {
                const textureLoader = new THREE.TextureLoader();
                buildingTexture = textureLoader.load('bina_apt.png');
                palmTrunkTexture = textureLoader.load('palm_texture.png');
                palmLeafTexture = textureLoader.load('palm_tree.png');
                
                clock = new THREE.Clock(); scene = new THREE.Scene();
                
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000); 
                isIntroPlaying = true;
                cinematicCameraTarget = new THREE.Vector3();

                renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game'), antialias: true }); 
                renderer.setSize(window.innerWidth, window.innerHeight); 
                renderer.shadowMap.enabled = true;
                
                renderer.outputColorSpace = THREE.SRGBColorSpace;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                
                scene.background = dayCycleParameters.NIGHT.background.clone();
                scene.fog = new THREE.Fog(dayCycleParameters.NIGHT.fog.clone(), dayCycleParameters.NIGHT.fogNear, dayCycleParameters.NIGHT.fogFar);
                
                hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
                scene.add(hemiLight);
                
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);

                dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
                dirLight.position.set(-80, 100, 50); 
                dirLight.castShadow = true;

                dirLight.shadow.mapSize.width = 1024; 
                dirLight.shadow.mapSize.height = 1024;
                dirLight.shadow.camera.near = 0.5; dirLight.shadow.camera.far = 500;
                dirLight.shadow.camera.left = -150; dirLight.shadow.camera.right = 150; 
                dirLight.shadow.camera.top = 150; dirLight.shadow.camera.bottom = -150;
                scene.add(dirLight); 
                
                createWorld(); 
                initializePalmTrees(); 
                updateHealth();

                camera.position.set(player.position.x + 10, player.position.y + 4, player.position.z + 10);
                camera.lookAt(player.position);

                setupControls(); 
                areHazardLightsOn = true;
                
                animate(); 
                
                window.addEventListener('resize', onWindowResize, false);
                document.getElementById('game').classList.add('visible');
                
                setTimeout(() => {
                    showSpeechBubble('player', 'Hmm, güzel araba... Artık benim.');
                }, 1500);

                document.getElementById('mission-container').style.display = 'none';

                if (sounds?.engine) sounds.engine.play();
            } catch(e) {
                displayError(e);
            }
        }
        
        // --- Animate ve diğer tüm yardımcı fonksiyonlar buraya ---
        // Not: Bu fonksiyonların çoğu önceki kodla aynı kalabilir,
        // ancak `moveWorld` gibi fonksiyonların InstancedMesh'i güncellemesi gerekir.
        // Bu örnekte, bu karmaşıklığı göstermek için temel yapıyı korudum.
        // Tam bir entegrasyon için animate döngüsünün de güncellenmesi gerekir.

        function animate() { 
            requestAnimationFrame(animate); 
            if (isGameOver) return;
            const deltaTime = clock.getDelta();

            // ... animate içeriğinin geri kalanı önceki koddan alınabilir,
            // sadece moveWorld içindeki InstancedMesh güncellemesi önemlidir.
            // Bu kod bloğu çok uzayacağı için kısa tutulmuştur.

            updatePlayerMovement();
            // ... diğer update fonksiyonları ...
            
            renderer.render(scene, camera);
        }

        window.addEventListener('DOMContentLoaded', () => { 
            loadSounds();
            loadAssets(); 
            setupGameStart(); 
        });

    </script>
</body>
</html>
